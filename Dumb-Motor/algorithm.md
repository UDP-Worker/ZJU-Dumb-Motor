# 小车循迹‑避障算法详解（面向 STM32F103RCT6）

> 本文完全聚焦**算法思想**及其内部协作关系，不讨论任何代码实现、硬件寄存器或调试细节。

------

## 1 问题抽象

小车需在两条黑带限定的“跑道”内行驶，同时绕过随机放置的障碍物。可用信息来源与动作能力如下：

| 类别         | 组件         | 信息 / 动作粒度                   |
| ------------ | ------------ | --------------------------------- |
| **跑道检测** | 两枚对地红外 | 二值：车身某侧是否压在黑带上      |
| **障碍检测** | 舵机‑超声波  | 连续：各方位到障碍物距离          |
| **机动能力** | 轮式底盘     | 离散原语：FWD、BRK、BWD、L10、R10 |

任务可被拆解为两条并行约束：

1. **跑道保持** — 小车必须处于安全走廊内；
2. **碰撞避免** — 若前方存在障碍，需改变航向后继续前行。

------

## 2 总体架构

算法采用三层逻辑：

```
感知层  →  行为层  →  执行层
          ↘  状态机  ↙
```

- **感知层** 以固定频率收集红外与超声数据，并进行最小化预处理（阈值化、量化）。
- **行为层** 分为两条子逻辑：
  - **循迹行为** 根据跑道误差信号提出“微步纠偏”请求；
  - **避障行为** 根据超声扇区占用情况提出“航向修正”请求。
- **状态机** 管理两种行为的优先级与互斥——正常行驶时以循迹为主，遇障后临时切换避障，避障完成后回归循迹。
- **执行层** 接收行为请求，将其序列化成“离散动作流”并逐一发送给底盘。此层不做任何高阶判断，是整个系统的节拍源。

------

## 3 跑道保持思想

### 3.1 误差编码

两枚对地红外可形成四种观测：

```
L=0,R=0  → ERR =  0  （中心）
L=1,R=0  → ERR = +1  （左压线）
L=0,R=1  → ERR = −1  （右压线）
L=1,R=1  → ERR = ±2 （完全跨线）
```

此 ERR 是**离散误差信号**。

### 3.2 微步补偿

底盘无法做连续差速，而是用固定角度“微步”来纠偏：

- ERR=±1 → 执行一次反向微转 (10°)，随后继续前推一小段；
- 连续出现同侧 ERR → 累积计数器 k，下一次转向执行 k × 10°；
- ERR=±2 → 刹车 + 后退 + 双步大转，确保迅速回到跑道内侧。

该策略等价于把连续 PID 控制**量化**到有限阶梯，既兼容低分辨率动作，又保留随时间增大的纠偏力度。

------

## 4 障碍避免思想

### 4.1 扫描与栅格化

舵机周期性地把超声波传感器旋转扫描 −90° 到 +90°。每个固定扇区测得距离 d_i 后进行二值化：

```
free_i = 1  ↔  d_i > D_SAFE
free_i = 0  ↔  d_i ≤ D_SAFE
```

### 4.2 约束融合

若某一时刻检测到车头正前方 free=0，则进入避障：

1. 把持续压线一侧的所有扇区强行置 0，禁止穿出跑道。
2. 在剩余的 free[] 中搜索最长连续 1 区间，表示视野中最宽的安全通道。
3. 取此区间中心角 θ* 作为**目标航向**。

### 4.3 离散化航向

用公式

[;n = \text{round}(\theta^*/10°);]\

得到需要执行 n 次 L10 或 R10。然后视情况附加若干步直行，令车辆移入安全通道并在后续循迹逻辑的帮助下重新“贴住”跑道中心。

------

## 5 执行层：动作序列化

循迹与避障会在不同时间点提出“若干微步 + 直行”请求。为了消除冲突，引入**先入先出动作队列**：

1. 行为层将自己生成的动作以序列形式写入队列；
2. 执行层按统一节拍取序列头部、执行对应电机动作；
3. 队列清空即表示该行为完成，有限状态机即可转移到下一个状态。

动作队列在概念上类似“运动宏”，它把策略的连续期望转化为底盘能理解的离散指令流，实现了**策略与执行解耦**。

------

## 6 有限状态机（FSM）

| 状态        | 主动行为   | 进入条件           | 退出条件              |
| ----------- | ---------- | ------------------ | --------------------- |
| **FOLLOW**  | 循迹       | 系统启动；避障完成 | 前方 blocked & 队列空 |
| **AVOID**   | 避障       | FOLLOW 检测到障碍  | 动作队列清空          |
| **RECOVER** | 仅监测跑道 | 避障结束           | 连续稳定中心 ≥ T_rec  |

此三态结构保证：

- 避障动作具有原子性（执行期间循迹不再抢占）；
- 避障结束后需在跑道中心保持一段时间再继续，否则容易在障碍堆重复切换。 

------

## 7 关键参数及其作用

| 参数         | 物理含义         | 算法角色                                 |
| ------------ | ---------------- | ---------------------------------------- |
| `10° 微步角` | 单次原地转向角度 | 离散化分辨率；越小越平滑，越大越迅速     |
| `D_SAFE`     | 安全距离阈值     | 决定避障提前量；过小易撞，过大易过度绕行 |
| `STEP_LIMIT` | 同侧压线最大累计 | 控制最大转向幅度；防止“风车式”振荡       |
| `T_rec`      | 恢复计数时间     | 确保车辆真正回到跑道中央再解锁避障       |

这些参数与硬件尺寸、车速和跑道宽度直接相关，原则上应通过离线实验标定，但其算法角色如上所述。

------

## 8 优势与局限

**优势**

- 完全整数逻辑，适合低算力 MCU；
- 行为‑执行解耦，可插拔其他决策策略；
- 微步离散化对硬件驱动简单、易标定。

**局限**

- 抗弯道能力受限于 10° 量化与计数器上限；
- 超声扫描速度决定对高速障碍的响应时延；
- 避障只考虑单层二维平面，无法处理重叠或动态障碍。

------

## 9 结语

该算法通过“误差离散化 + 栅格化视野 + 队列执行 + 三态管理”的组合，成功用极简传感器与动作集解决跑道保持和随机静态障碍避让问题。在更高算力或更丰富传感器条件下，可将微步角度进一步细分、引入概率地图或局部路径规划，但核心拆分思路（感知 ↔ 行为 ↔ 执行）依然适用。

---
