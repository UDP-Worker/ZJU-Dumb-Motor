# 小车循迹‑避障算法详解（面向 STM32F103RCT6）

## 目录

1. 系统概览
2. 关键硬件资源
3. 动作原语与角度校准
4. 指令队列执行框架
5. 定时与中断组织
6. 跑道保持（循迹）算法
7. 超声波扫描与避障算法
8. 有限状态机工作流程
9. 关键参数与调试步骤
10. 常见故障排查

---

## 1 系统概览

本文件说明如何仅凭两枚对地红外循迹传感器、一个带舵机的超声波测距模块，以及 STM32F103RCT6 主控，完成“跑道内行驶且自动避障”的任务。算法核心思想是：

* 用**对地红外**实时检测跑道边界，并通过离散的“微步转向”保持小车始终位于两条黑带之间。
* 用**舵机‑超声波**周期性扫描前方半圆形区域，发现障碍后计算一个安全航向，并把该航向转换成若干个固定角度微步；再通过排队方式依次执行这些微步，从而在保持跑道约束的同时绕过障碍。

整套逻辑以**有限状态机**为骨架，以**指令队列**为执行中介，既避免浮点计算，也让高层算法与底层电机驱动彻底解耦，十分适合资源有限又缺乏控制论背景的开发者。

## 2 关键硬件资源

### 2.1 传感器

对地红外模块两只，数字输出 0 或 1，分别记为 L（左）与 R（右）。舵机带动 HC‑SR04（或同级别）超声波模块。

### 2.2 执行机构

两轮差速底盘，电机控制被抽象成五类离散动作：直行 FWD，刹车 BRK，后退 BWD，左转 L10，右转 R10。L10 与 R10 约对应 “原地转向 10°”，实际角度需在实体地面上标定。

### 2.3 片上外设分配

TIM1 与 TIM2 输出 PWM 驱动左右电机；TIM3 产生 1 kHz 周期中断读取对地红外；TIM4 捕获超声回波，亦在其更新事件中驱动舵机占空；SysTick 或另一个通用定时器负责 1 ms 任务节拍，用于指令队列执行器。

## 3 动作原语与角度校准

电机只能做离散动作，故须先把“原地 10° 微步”定标。方法为：

1. 在平面粘贴一条十字基准线；
2. 令小车前进到交点中心后停止；
3. 发送一次 L10 指令并记录车头角度变化；
4. 通过调整 PWM 占空和持续时间，使该角度稳定在 8 °–12°；
5. 同理标定 R10。完成后把数值写入常量，例如 `TURN_US=52ms`。

直行、倒退和刹车同理，用平均位移或停止距离标定其持续时间，从而保证后文算法中的数量级估算成立。

## 4 指令队列执行框架

高层决策模块永远不直接驱动电机，而是**往循环 FIFO 中写入指令**。队列元素结构如下：

```c
typedef enum {FWD, BRK, L10, R10, BWD} Act;
typedef struct {Act a; uint16_t t_ms;} Cmd;  // t_ms = 推荐持续时间
Cmd q[32];
volatile uint8_t qi = 0; // 读指针（执行端）
volatile uint8_t qj = 0; // 写指针（决策端）
```

执行器在 1 ms 节拍下工作，若当前指令剩余时长减到零即出队读取下一条；队列若空，则自动执行 FWD 以维持前进。这样循迹控制、避障规划、乃至今后的蓝牙遥控，都只是“写指令”即可。

## 5 定时与中断组织

* **1 kHz 红外采样中断**：读取 L、R 并立即写入全局状态。
* **超声回波捕获中断**：记录脉宽并换算距离；最高优先级。
* **舵机更新事件**：每 50 ms 增量改变舵角，实现平滑扫描。
* **1 ms 调度中断**：

    * 指令队列计时与换挡；
    * 1000 ms 内部计数到 0 时触发一次 VFH Light 计算；
    * 状态机转移检查。

## 6 跑道保持（循迹）算法

### 6.1 误差编码

传感器 L、R 的组合共有四种，算法把它们映射成“跑道误差”：

* L=0、R=0 → `ERR=0`；
* L=1、R=0 → `ERR=+1`（车身左侧压线，需要右调）；
* L=0、R=1 → `ERR=-1`（车身右侧压线，需要左调）；
* L=1、R=1 → `ERR=±2`（完全越界，以历史单边压线符号为准）。

### 6.2 微步计数器

设置一个 `uint8_t step_cnt`。当 ERR=0 时计数器回零；当出现单边压线时计数器递增（上限 3）。计数器的值决定接下来要排入队列的 L10/R10 次数。例如 `step_cnt=2` 则排入两次 L10（或 R10）。这样在连续压线场景下拐弯幅度会自动变大，等价于 PID 的积分项。

### 6.3 指令生成逻辑示例

红外采样中断内只统计 ERR 与 step\_cnt，自身不排队。主循环每 10 ms 调 `update_follow()`：

1. 若队列仍有未执行指令，立即返回。
2. 根据当前 ERR：

    * ERR=0 → `enqueue(FWD, 60);`
    * ERR=+1 → `enqueue(R10, TURN_US); enqueue(FWD, 40);`
    * ERR=-1 → 对称；
    * ERR=±2 → `enqueue(BRK, 40); enqueue(BWD, 60); enqueue(R10/L10, TURN_US*2);`

如上逻辑完全整数化，无需任何控制理论背景即可维护跑道。

## 7 超声波扫描与避障算法

### 7.1 扫描策略

舵机周期 100 ms 改变一次脉宽，20 步扫完 55° 至 +180°(55°为左边界，115°为中轴线，180°为右边界)。每次停留约 5 ms 供超声测距，其回波捕获中断在 2 ms 内完成，无冲突。

### 7.2 安全栅格生成

把扫描得到的 21 个距离值量化为二元数组 `free[21]`：若距离大于阈值 `D_SAFE`（初值 40 cm）则记 1，否则记 0。若 L 或 R 当前为 1，则把对应半边数组全置 0，防止算法把跑道外区域当成可行通道。

### 7.3 航向选取与离散化

遍历 `free[]`，找出最长连续的 1 区间，取区间中心角 `theta*`。然后：

```c
int n = (theta* - 0 /*车头角*/ + 5)/10;   // 四舍五入到 10°
if(n>0) enqueue(L10, TURN_US) n 次;
if(n<0) enqueue(R10, TURN_US) |n| 次;
enqueue(FWD, 120);   // 冲出去再说
```

此过程触发条件为“超声正前方扇区 free=0 并且队列空”。执行完毕后有限状态机返回 FOLLOW。

## 8 有限状态机工作流程

系统状态存在 `g_state`：FOLLOW、AVOID、RECOVER 三个取值。

* FOLLOW：只运行循迹逻辑；若前方 0° 扇区 free=0 且距障阈值内，则切到 AVOID。
* AVOID：一次性写入避障指令（如 7.3），立即执行；执行期间仍监测跑道压线，若发生压线则插入补偿指令。
* RECOVER：避障执行完毕，等待 L=R=0 持续 200 ms 后自动切回 FOLLOW。

状态机实质只影响“什么时候允许写指令”，因此代码实现仍可归结为 switch‑case。

## 9 关键参数与调试步骤

* `TURN_US`：单步转向持续时间，标定角度 ≈10°。
* `FWD_US`：直行微步持续时间，建议 50 ms 起步，过大会因弯道冲线。
* `D_SAFE`：超声判定安全距离，初值 40 cm，根据环境与车速微调。
* `step_cnt_limit`：单边压线最大记数，建议 3。

整体调参流程：

1. **循迹**：空跑道内调 TURN\_US 与 FWD\_US，使车辆不摆尾；随后把 step\_cnt\_limit 加到 3，确认在急弯也不会冲线。
2. **避障**：放 20 cm 高盒子在跑道中央，调 D\_SAFE 与 L10/R10 累加次数，直至车辆能从左右绕过。
3. **极端**：盒子贴近黑带边缘，验证压线补偿仍生效，否则适当加大压线情况下的 BWD 时长。

## 11 常见故障排查

1. **小车左右蹿动或锯齿行走**：TURN\_US 过大或 FWD\_US 过小，导致刚纠正就重新压线，应减小转向持续时间或放宽前进时间。
2. **脱离跑道外绕障，无法回归**：避障算法产生转向过大，应减小 L10/R10 步数或降低 D\_SAFE。
3. **舵机扫描导致超声测距失真**：舵机移动过快，回波仍在飞行；确保一次移动后至少等待 30 ms 再触发超声测距。
4. **超声误触发导致频繁 AVOID**：检查地面或墙面反射；可在软件上加均值滤波与最小触发间隔（>200 ms）。

---
